import React, { useState, useEffect, useMemo } from 'react';
import { motion } from 'framer-motion';

// –ò–∫–æ–Ω–∫–∏ —á–µ—Ä–µ–∑ SVG
const StarIcon = ({ filled, size = 20 }) => (
  <svg 
    width={size} 
    height={size} 
    viewBox="0 0 24 24" 
    fill={filled ? "currentColor" : "none"} 
    stroke="currentColor" 
    strokeWidth="2"
  >
    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />
  </svg>
);

const CrownIcon = ({ size = 20, color = "currentColor" }) => (
  <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2.5">
    <path d="M2 4l3 12h14l3-12-6 7-4-7-4 7-6-7z" fill={color} fillOpacity="0.2" />
    <path d="M19 16v3a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-3" />
  </svg>
);

const App = () => {
  const [loading, setLoading] = useState(true);
  const [items, setItems] = useState(() => {
    const saved = localStorage.getItem('eval_react_pro_v2');
    return saved ? JSON.parse(saved) : [];
  });
  const [activeTab, setActiveTab] = useState('list');
  const [editingId, setEditingId] = useState(null);
  const [newItemName, setNewItemName] = useState('');
  const [searchQuery, setSearchQuery] = useState('');
  const [pendingImg, setPendingImg] = useState(null);

  useEffect(() => {
    localStorage.setItem('eval_react_pro_v2', JSON.stringify(items));
  }, [items]);

  useEffect(() => {
    const timer = setTimeout(() => setLoading(false), 1200);
    return () => clearTimeout(timer);
  }, []);

  const addItem = () => {
    if (!newItemName.trim()) return;
    const now = new Date();
    const months = ["—è–Ω–≤–∞—Ä—è", "—Ñ–µ–≤—Ä–∞–ª—è", "–º–∞—Ä—Ç–∞", "–∞–ø—Ä–µ–ª—è", "–º–∞—è", "–∏—é–Ω—è", "–∏—é–ª—è", "–∞–≤–≥—É—Å—Ç–∞", "—Å–µ–Ω—Ç—è–±—Ä—è", "–æ–∫—Ç—è–±—Ä—è", "–Ω–æ—è–±—Ä—è", "–¥–µ–∫–∞–±—Ä—è"];
    
    const newItem = {
      id: Date.now(),
      name: newItemName.trim(),
      date: `${now.getDate()} ${months[now.getMonth()]}`,
      image: pendingImg,
      criteria: { vity: 0, kor: 0, pet: 0 }
    };
    setItems([newItem, ...items]);
    setNewItemName('');
    setPendingImg(null); 
    setEditingId(newItem.id);
  };

  const deleteItem = (id) => {
    setItems(items.filter(i => i.id !== id));
    if (editingId === id) setEditingId(null);
  };

  const updateRating = (itemId, criterion, value) => {
    setItems(items.map(item => {
      if (item.id === itemId) {
        const newVal = item.criteria[criterion] === value ? 0 : value;
        return { ...item, criteria: { ...item.criteria, [criterion]: newVal } };
      }
      return item;
    }));
  };

  const calcPts = (c) => (c.vity * 1) + (c.kor * 10) + (c.pet * 100);

  const filteredItems = useMemo(() => {
    let list = [...items].filter(it => it.name.toLowerCase().includes(searchQuery.toLowerCase()));
    if (activeTab === 'stats') {
      return list.sort((a, b) => calcPts(b.criteria) - calcPts(a.criteria));
    }
    return list;
  }, [items, activeTab, searchQuery]);

  const handleFileChange = (e, id = null) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      if (id) {
        setItems(items.map(it => it.id === id ? { ...it, image: ev.target.result } : it));
      } else {
        setPendingImg(ev.target.result); 
      }
    };
    reader.readAsDataURL(file);
  };

  if (loading) {
    return (
      <div className="fixed inset-0 bg-[#020617] flex items-center justify-center z-50">
        <div className="relative">
          <motion.div 
            animate={{ scale: [1, 1.8], opacity: [1, 0] }}
            transition={{ repeat: Infinity, duration: 1 }}
            className="absolute inset-0 text-blue-500/50"
          >
            <StarIcon size={60} filled />
          </motion.div>
          <motion.div 
            animate={{ scale: [1, 1.2, 1] }}
            transition={{ repeat: Infinity, duration: 1 }}
            className="text-blue-500 relative z-10"
          >
            <StarIcon size={60} filled />
          </motion.div>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-[#020617] text-slate-100 p-3 font-sans overflow-x-hidden selection:bg-blue-500/30 pb-10">
      <div className="max-w-md mx-auto">
        
        <header className="mb-6 text-center pt-2">
          <h1 className="text-3xl font-black italic uppercase tracking-tighter bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
            –û—Ü–µ–Ω–∏–≤–∞—Ç–µ–ª—å
          </h1>
        </header>

        {/* –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏ –ø–æ–∏—Å–∫ */}
        <section className="bg-slate-900/40 p-3 rounded-[1.5rem] border border-white/5 mb-6 space-y-3 shadow-2xl backdrop-blur-sm">
          <div className="flex gap-2 items-center bg-slate-950/40 p-1 rounded-2xl border border-white/5">
            <button 
              onClick={() => document.getElementById('new-img').click()}
              className={`w-11 h-11 rounded-xl flex items-center justify-center transition-all shrink-0 ${pendingImg ? 'bg-blue-600/20 text-blue-400' : 'bg-slate-800/50 text-slate-500'}`}
            >
              {pendingImg ? <img src={pendingImg} className="w-full h-full object-cover rounded-xl" /> : <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>}
            </button>
            <input 
              type="text" 
              value={newItemName}
              onChange={(e) => setNewItemName(e.target.value)}
              placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ..."
              className="flex-1 bg-transparent px-2 h-11 text-sm outline-none text-white placeholder:text-slate-600"
            />
            <button 
              onClick={addItem}
              className="w-11 h-11 bg-blue-600 text-white rounded-xl flex items-center justify-center text-xl font-black shadow-lg shadow-blue-900/40 active:scale-90 transition-transform shrink-0"
            >
              +
            </button>
          </div>
          
          <div className="relative">
            <div className="absolute inset-y-0 left-3 flex items-center pointer-events-none text-slate-600">
                <svg width="12" height="12" fill="none" stroke="currentColor" strokeWidth="3" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
            </div>
            <input 
              type="text"
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              placeholder="–ë–´–°–¢–†–´–ô –ü–û–ò–°–ö..."
              className="w-full bg-slate-950/30 border border-white/5 rounded-lg pl-8 pr-4 py-1.5 text-[9px] font-black tracking-widest text-slate-500 outline-none focus:border-blue-500/30 uppercase"
            />
          </div>
          <input type="file" id="new-img" hidden accept="image/*" onChange={(e) => handleFileChange(e)} />
        </section>

        {/* –¢–∞–±—ã */}
        <div className="flex bg-slate-900/80 p-1 rounded-xl mb-6 border border-white/5">
          {['list', 'stats'].map((tab) => (
            <button
              key={tab}
              onClick={() => { setActiveTab(tab); setEditingId(null); }}
              className={`flex-1 py-2.5 rounded-lg font-bold text-[9px] uppercase tracking-widest transition-all ${
                activeTab === tab ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-500'
              }`}
            >
              {tab === 'list' ? '–õ–µ–Ω—Ç–∞' : '–ó–∞–ª —Å–ª–∞–≤—ã'}
            </button>
          ))}
        </div>

        {/* –°–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç–æ—á–µ–∫ */}
        <div className="space-y-3">
          {filteredItems.map((item, index) => {
            const isEditing = editingId === item.id;
            const points = calcPts(item.criteria);
            
            const isTop3 = activeTab === 'stats' && index < 3 && searchQuery === '';
            
            // –°—Ç–∏–ª–∏ –¥–ª—è –¢–û–ü-3
            const rankConfig = {
              0: { color: 'text-yellow-400', border: 'border-yellow-500/50', bg: 'bg-yellow-500/10', shadow: 'shadow-[0_0_20px_rgba(234,179,8,0.15)]' },
              1: { color: 'text-slate-300', border: 'border-slate-400/50', bg: 'bg-slate-400/10', shadow: 'shadow-lg' },
              2: { color: 'text-orange-400', border: 'border-orange-600/50', bg: 'bg-orange-600/10', shadow: 'shadow-md' }
            };

            const currentRank = isTop3 ? rankConfig[index] : null;

            return (
              <div
                key={item.id}
                className={`rounded-[1.5rem] overflow-hidden border transition-all ${
                  isEditing 
                  ? 'border-blue-500 bg-slate-900 shadow-2xl' 
                  : isTop3 
                    ? `${currentRank.border} ${currentRank.bg} ${currentRank.shadow}` 
                    : 'border-white/5 bg-slate-900/60'
                }`}
                onClick={() => !isEditing && setEditingId(item.id)}
              >
                {isEditing ? (
                  <div className="p-4">
                    <div 
                      className="h-48 bg-slate-950 rounded-2xl mb-4 overflow-hidden border border-white/5 flex items-center justify-center relative"
                      onClick={(e) => { e.stopPropagation(); document.getElementById(`edit-img-${item.id}`).click(); }}
                    >
                      {item.image ? (
                        <img src={item.image} className="w-full h-full object-cover" />
                      ) : (
                        <div className="flex flex-col items-center gap-1 text-slate-800">
                           <StarIcon size={24} filled />
                           <span className="text-[8px] font-black uppercase tracking-widest">–§–æ—Ç–æ</span>
                        </div>
                      )}
                    </div>
                    <input type="file" id={`edit-img-${item.id}`} hidden accept="image/*" onChange={(e) => handleFileChange(e, item.id)} />

                    <div className="flex justify-between items-end mb-6">
                      <div>
                        <div className="text-[8px] font-bold text-slate-500 uppercase tracking-widest mb-0.5">{item.date}</div>
                        <h3 className="font-black text-lg uppercase text-slate-100 pr-2 truncate max-w-[150px]">{item.name}</h3>
                      </div>
                      <motion.span 
                        key={points}
                        initial={{ scale: 1.5, color: '#60a5fa' }}
                        animate={{ scale: 1, color: '#60a5fa' }}
                        className="text-4xl font-black italic leading-none"
                      >
                        {points}
                      </motion.span>
                    </div>

                    <div className="space-y-4 mb-6">
                      <RatingRow label="–ü–ï–¢–†–û–í–´ (x100)" color="text-indigo-500" val={item.criteria.pet} onRate={(v) => updateRating(item.id, 'pet', v)} />
                      <RatingRow label="–ö–û–†–û–°–¢–´–®–ï–í–°–ö–ò–ï (x10)" color="text-amber-500" val={item.criteria.kor} onRate={(v) => updateRating(item.id, 'kor', v)} />
                      <RatingRow label="–í–ò–¢–´ (x1)" color="text-blue-500" val={item.criteria.vity} onRate={(v) => updateRating(item.id, 'vity', v)} />
                    </div>

                    <div className="flex gap-2">
                      <button 
                        onClick={(e) => { e.stopPropagation(); setEditingId(null); }}
                        className="flex-1 bg-blue-600 py-3 rounded-xl font-black uppercase text-[10px] tracking-widest active:scale-95 transition-transform"
                      >
                        –û–ö
                      </button>
                      <button 
                        onClick={(e) => { e.stopPropagation(); if(confirm('–£–¥–∞–ª–∏—Ç—å?')) deleteItem(item.id); }}
                        className="bg-red-500/10 px-5 rounded-xl text-red-500 border border-red-500/10 active:scale-95 transition-transform"
                      >
                        üóë
                      </button>
                    </div>
                  </div>
                ) : (
                  <div className={`p-4 flex gap-4 items-center cursor-pointer transition-colors ${isTop3 ? '' : 'active:bg-white/5'}`}>
                    <div className={`relative shrink-0`}>
                       {isTop3 && (
                         <div className={`absolute -top-3 -left-2 -rotate-12 ${currentRank.color}`}>
                           <CrownIcon size={20} color="currentColor" />
                         </div>
                       )}
                       <div className={`w-14 h-14 rounded-2xl overflow-hidden flex items-center justify-center border ${isTop3 ? currentRank.border : 'border-white/5 bg-slate-950'}`}>
                        {item.image ? (
                          <img src={item.image} className="w-full h-full object-cover" />
                        ) : (
                          <span className="text-slate-800"><StarIcon size={20} filled /></span>
                        )}
                      </div>
                      {isTop3 && (
                        <div className={`absolute -bottom-2 -right-2 w-6 h-6 rounded-full bg-slate-950 border ${currentRank.border} flex items-center justify-center text-[10px] font-black ${currentRank.color}`}>
                          {index + 1}
                        </div>
                      )}
                    </div>
                    
                    <div className="flex-1 min-w-0">
                      <div className="flex justify-between items-center mb-1">
                        <div>
                          <h3 className={`font-black text-[13px] uppercase truncate tracking-tight ${isTop3 ? 'text-white' : 'text-slate-100'}`}>
                            {item.name}
                          </h3>
                        </div>
                        <motion.span 
                          key={points}
                          animate={{ scale: [1, 1.2, 1] }}
                          className={`text-2xl font-black italic ml-2 leading-none ${isTop3 ? currentRank.color : 'text-blue-400'}`}
                        >
                          {points}
                        </motion.span>
                      </div>
                      <div className={`flex flex-col gap-0.5 ${isTop3 ? 'opacity-70' : 'opacity-40'} scale-90 origin-left`}>
                        <MiniStars val={item.criteria.pet} color="text-indigo-400" />
                        <MiniStars val={item.criteria.kor} color="text-amber-400" />
                        <MiniStars val={item.criteria.vity} color="text-blue-400" />
                      </div>
                    </div>
                  </div>
                )}
              </div>
            );
          })}
        </div>
      </div>
    </div>
  );
};

const RatingRow = ({ label, color, val, onRate }) => (
  <div className="space-y-2">
    <div className="flex justify-between items-center">
      <span className={`text-[8px] font-black uppercase tracking-widest ${color} opacity-80`}>{label}</span>
      <span className={`text-[9px] font-black ${color}`}>{val}/10</span>
    </div>
    <div className={`flex justify-between ${color} gap-0.5`}>
      {[...Array(10)].map((_, i) => (
        <motion.button 
          key={i} 
          whileTap={{ scale: 1.8 }}
          onClick={(e) => { e.stopPropagation(); onRate(i + 1); }}
          className="flex-1 py-0.5"
        >
          <StarIcon filled={i < val} size={18} />
        </motion.button>
      ))}
    </div>
  </div>
);

const MiniStars = ({ val, color }) => (
  <div className={`flex gap-0.5 ${color}`}>
    {[...Array(10)].map((_, i) => (
      <div key={i} className={i < val ? 'opacity-100' : 'opacity-20'}>
        <StarIcon size={7} filled />
      </div>
    ))}
  </div>
);

export default App;

